<modification>

	<id>Force Customer Login</id>
	<version>300.1</version>
	<vqmver>2.6.2</vqmver>
	<author>Qphoria</author>

	<file name="catalog/controller/common/header.php">
		<operation>
			<search position="after"><![CDATA[
			function index()
			]]></search>
			<add trim="false"><![CDATA[
			//Q: Force Customer Login
			if (!$this->customer->isLogged()) {
				$match = false;
				if (!empty($this->request->get['route'])) {

					$skip = array(
						'payment',
						'feed',
						'forgotten',
						'login',
						'register'
					);

					foreach ($skip as $s) {
						if (strpos($this->request->get['route'], $s) !== false) {
							$match = true;
							break;
						}
					}
				}

				// Allow home page to be loaded by uncommenting the middle line
				if ($_SERVER['QUERY_STRING'] == "") {
					//$match = true;
				}

				$dest_route = 'account/login';
				if (!$match) {
					if ($_SERVER['QUERY_STRING'] != 'route=' . $dest_route) {
						$this->response->redirect($this->url->link($dest_route, '', 'SSL'));
					}
				}
			}
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/account/login.php">
        <operation>
            <search position="replace"><![CDATA[
            $data['column_left'] = $this->load->controller('common/column_left')
            ]]></search>
            <add><![CDATA[
            if ($this->customer->isLogged()) {
                $data['column_left'] = $this->load->controller('common/column_left');
                $data['column_right'] = $this->load->controller('common/column_right');
                $data['content_top'] = $this->load->controller('common/content_top');
                $data['content_bottom'] = $this->load->controller('common/content_bottom');
            }
            ]]></add>
        </operation>
	</file>

    <file name="catalog/view/theme/basf/template/account/login.twig">
        <operation>
            <search position="replace" index="1" offset="50"><![CDATA[
            <ul class="breadcrumb">
            ]]></search>
            <add><![CDATA[
            <div class="container-fluid"><br />
                <h1 align="center">Welcome to your </br></br>BASF Branded Fulfillment Site</h1>
                <br/>
                <br/>
                <br/>
                <div class="row">
                    <div class="col-sm-offset-4 col-sm-4">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h1 class="panel-title"><i class="fa fa-lock"></i>Please login with your BASF account</h1>
                            </div>
                            <div class="panel-body">
                                {% if success %}
                                <div class="alert alert-success alert-dismissible"><i class="fa fa-check-circle"></i> {{ success }}</div>
                                {% endif %}
                                {% if error_warning %}
                                <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}</div>
                                {% endif %}
                                <form action="{{ action }}" method="post" enctype="multipart/form-data">
                                    <div class="form-group">
                                        <label class="control-label" for="input-email">{{ entry_email }}</label>
                                        <div class="input-group"><span class="input-group-addon"><i class="fa fa-user"></i></span>
                                            <input type="text" name="email" value="{{ email }}" placeholder="{{ entry_email }}" id="input-email" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label" for="input-password">{{ entry_password }}</label>
                                        <div class="input-group"><span class="input-group-addon"><i class="fa fa-lock"></i></span>
                                            <input type="password" name="password" value="{{ password }}" placeholder="{{ entry_password }}" id="input-password" class="form-control" />
                                        </div>
                                        <a href="{{ forgotten }}">{{ text_forgotten }}</a>
                                    </div>
                                    <input type="submit" value="{{ button_login }}" class="btn btn-primary" />
                                    {% if redirect %}
                                    <input type="hidden" name="redirect" value="{{ redirect }}" />
                                    {% endif %}
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ]]></add>
        </operation>
	</file>

</modification>