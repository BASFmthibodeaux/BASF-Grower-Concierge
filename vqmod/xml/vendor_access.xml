<modification>

	<id>Vendor Access</id>
	<version>300.1</version>
	<vqmver>2.6.2</vqmver>

    <file name="admin\model\catalog\product.php">
		<operation>
			<search position="replace" offset="1"><![CDATA[
            public function addProduct($data) {
			]]></search>
			<add><![CDATA[
            public function addProduct($data) {
        		$this->db->query("INSERT INTO " . DB_PREFIX . "product SET model = '" . $this->db->escape($data['model']) . "', sku = '" . $this->db->escape($data['sku']) . "', upc = '" . $this->db->escape($data['upc']) . "', ean = '" . $this->db->escape($data['ean']) . "', jan = '" . $this->db->escape($data['jan']) . "', isbn = '" . $this->db->escape($data['isbn']) . "', mpn = '" . $this->db->escape($data['mpn']) . "', location = '" . $this->db->escape($data['location']) . "', quantity = '" . (int)$data['quantity'] . "', minimum = '" . (int)$data['minimum'] . "', subtract = '" . (int)$data['subtract'] . "', stock_status_id = '" . (int)$data['stock_status_id'] . "', date_available = '" . $this->db->escape($data['date_available']) . "', manufacturer_id = '" . (int)$data['manufacturer_id'] . "', vendor_id = '" . (int)$data['vendor_id'] . "', shipping = '" . (int)$data['shipping'] . "', price = '" . (float)$data['price'] . "', points = '" . (int)$data['points'] . "', weight = '" . (float)$data['weight'] . "', weight_class_id = '" . (int)$data['weight_class_id'] . "', length = '" . (float)$data['length'] . "', width = '" . (float)$data['width'] . "', height = '" . (float)$data['height'] . "', length_class_id = '" . (int)$data['length_class_id'] . "', status = '" . (int)$data['status'] . "', tax_class_id = '" . (int)$data['tax_class_id'] . "', sort_order = '" . (int)$data['sort_order'] . "', date_added = NOW(), date_modified = NOW()");
	        ]]></add>
		</operation>

        <operation>
			<search position="replace" offset="1"><![CDATA[
            public function editProduct($product_id, $data) {
			]]></search>
			<add><![CDATA[
            public function editProduct($product_id, $data) {
        		$this->db->query("UPDATE " . DB_PREFIX . "product SET model = '" . $this->db->escape($data['model']) . "', sku = '" . $this->db->escape($data['sku']) . "', upc = '" . $this->db->escape($data['upc']) . "', ean = '" . $this->db->escape($data['ean']) . "', jan = '" . $this->db->escape($data['jan']) . "', isbn = '" . $this->db->escape($data['isbn']) . "', mpn = '" . $this->db->escape($data['mpn']) . "', location = '" . $this->db->escape($data['location']) . "', quantity = '" . (int)$data['quantity'] . "', minimum = '" . (int)$data['minimum'] . "', subtract = '" . (int)$data['subtract'] . "', stock_status_id = '" . (int)$data['stock_status_id'] . "', date_available = '" . $this->db->escape($data['date_available']) . "', manufacturer_id = '" . (int)$data['manufacturer_id'] . "', vendor_id = '" . (int)$data['vendor_id'] . "', shipping = '" . (int)$data['shipping'] . "', price = '" . (float)$data['price'] . "', points = '" . (int)$data['points'] . "', weight = '" . (float)$data['weight'] . "', weight_class_id = '" . (int)$data['weight_class_id'] . "', length = '" . (float)$data['length'] . "', width = '" . (float)$data['width'] . "', height = '" . (float)$data['height'] . "', length_class_id = '" . (int)$data['length_class_id'] . "', status = '" . (int)$data['status'] . "', tax_class_id = '" . (int)$data['tax_class_id'] . "', sort_order = '" . (int)$data['sort_order'] . "', date_modified = NOW() WHERE product_id = '" . (int)$product_id . "'");
	        ]]></add>
		</operation>

        <operation>
			<search position="before"><![CDATA[
            'p.status',
			]]></search>
			<add><![CDATA[
            'p.vendor_id',
	        ]]></add>
		</operation>

        <operation>
			<search position="before"><![CDATA[
            if (isset($data['filter_status']) && $data['filter_status'] !== '') {
			]]></search>
			<add><![CDATA[
            if (!empty($data['filter_vendor_id'])) {
			    $sql .= " AND p.vendor_id = '" . (int)$data['filter_vendor_id'] . "'";
		    }
	        ]]></add>
		</operation>

    </file>

    <file name="admin\language\en-gb\catalog\product.php">
		<operation>
			<search position="after"><![CDATA[
            $_['error_unique']           = 'SEO URL must be unique!';
			]]></search>
			<add><![CDATA[
            $_['entry_vendor']           = 'Vendor';
            $_['help_vendor']            = 'Select Vendor Account';
            $_['column_vendor']          = 'Vendor';
	        ]]></add>
		</operation>
    </file>

    <file name="admin\controller\catalog\product.php">
		<operation>
			<search position="after"><![CDATA[
            protected function getList() {
			]]></search>
			<add><![CDATA[
            $this->load->model('user/user');
		
		    $data['vendors'] = array();
		    $users = $this->model_user_user->getUsers();
		
            foreach ($users as $user) {
                if ((int)$user['user_group_id'] == 10) {
                    $data['vendors'][] = array(
                        'vendor_id' 	 => $user['user_id'],
                        'name'			 => $user['username']
                    );
                }
            }

            $filter_vendor_id = null;
            $user_info = $this->model_user_user->getUser($this->user->getId());
            $data['user_group_id'] = $user_info['user_group_id'];
            
            if ((int)$user_info['user_group_id'] == 10) {
                $filter_vendor_id = $user_info['user_id'];
                $data['vendor_user'] = true;
            }

            if ($filter_vendor_id == null) {
                if (isset($this->request->get['filter_vendor_id'])) {
                    $filter_vendor_id = $this->request->get['filter_vendor_id'];
                } else{
                    $filter_vendor_id = '';
                }
		    }
	        ]]></add>
		</operation>

        <operation>
			<search position="before" index="6,7,8"><![CDATA[
            if (isset($this->request->get['filter_status'])) {
			]]></search>
			<add><![CDATA[
            // Avash
            if ($filter_vendor_id == null && isset($this->request->get['filter_vendor_id'])) {
                $url .= '&filter_vendor_id=' . $this->request->get['filter_vendor_id'];
            }
	        ]]></add>
		</operation>

        <operation>
			<search position="before"><![CDATA[
            'filter_status'   => $filter_status,
			]]></search>
			<add><![CDATA[
            'filter_vendor_id'	  => $filter_vendor_id,
	        ]]></add>
		</operation>

        <operation>
			<search position="after"><![CDATA[
            'quantity'   => $result['quantity'],
			]]></search>
			<add><![CDATA[
            'vendor_id'	 => $result['vendor_id'],
	        ]]></add>
		</operation>

        <operation>
			<search position="before"><![CDATA[
			$data['sort_status'] = $this->url->link('catalog/product', 'user_token=' . $this->session->data['user_token'] . '&sort=p.status' . $url, true);
            ]]></search>
			<add><![CDATA[
	        $data['sort_vendor_id'] = $this->url->link('catalog/product', 'user_token=' . $this->session->data['user_token'] . '&sort=p.vendor_id' . $url, true);
            ]]></add>
		</operation>

        <operation>
			<search position="before"><![CDATA[
			$data['filter_status'] = $filter_status;
            ]]></search>
			<add><![CDATA[
	        $data['filter_vendor_id'] = $filter_vendor_id;
            ]]></add>
		</operation>

        <operation>
			<search position="before"><![CDATA[
			// Categories   
            ]]></search>
			<add><![CDATA[
	        // Vendor
            $this->load->model('user/user');
            
            $data['vendor_users'] = array();
            $users = $this->model_user_user->getUsers();
            
            foreach ($users as $user) {
                if ((int)$user['user_group_id'] == 10) {
                    $data['vendor_users'][] = array(
                        'vendor_user_id' => $user['user_id'],
                        'name'			 => $user['username']
                    );
                }
            }

            $user_info = $this->model_user_user->getUser($this->user->getId());
            $data['user_group_id'] = $user_info['user_group_id'];


            if ((int)$user_info['user_group_id'] == 10) {
                if (empty($product_info)) {
                    $data['vendor_id'] = $user_info['user_id'];
                } else {
                    $data['vendor_id'] = $product_info['vendor_id'];
                }
            } else {
                if (isset($this->request->post['vendor_id'])) {
                    $data['vendor_id'] = $this->request->post['vendor_id'];
                } elseif (!empty($product_info)) {
                    $data['vendor_id'] = $product_info['vendor_id'];
                } else {
                    $data['vendor_id'] = '';
                }
            }
            ]]></add>
		</operation>

    </file>

    <file name="admin\view\template\catalog\product_list.twig">
		<operation>
			<search position="after" offset="1"><![CDATA[
            <input type="text" name="filter_quantity" value="{{ filter_quantity }}" placeholder="{{ entry_quantity }}" id="input-quantity" class="form-control" />
			]]></search>
			<add><![CDATA[
            <div class="form-group" {% if vendor_user %} style="display:none" {% endif %}>
              <label class="control-label" for="input-vendor">{{ entry_vendor }}</label>
              <select name="filter_vendor_id" id="input-vendor" class="form-control"> 
                <option value=""></option>
                {% for vendor in vendors %}
                {% if vendor.vendor_id == filter_vendor_id %}
                  <option value="{{ vendor.vendor_id }}" selected="selected">{{ vendor.name }}</option>
                {% else %}                  
                  <option value="{{ vendor.vendor_id }}">{{ vendor.name }}</option>
                {% endif %}
                {% endfor %}
              </select>
            </div>
	        ]]></add>
		</operation>

        <operation>
			<search position="after"><![CDATA[
            <td class="text-right">{% if sort == 'p.quantity' %} <a href="{{ sort_quantity }}" class="{{ order|lower }}">{{ column_quantity }}</a> {% else %} <a href="{{ sort_quantity }}">{{ column_quantity }}</a> {% endif %}</td>
			]]></search>
			<add><![CDATA[
            {% if not vendor_user %} 
                <td class="text-left">{% if sort == 'p.vendor_id' %} <a href="{{ sort_vendor_id }}" class="{{ order|lower }}">{{ column_vendor }}</a> {% else %} <a href="{{ sort_vendor_id }}">{{ column_vendor }}</a> {% endif %}</td>
            {% endif %}
	        ]]></add>
		</operation>

        <operation>
			<search position="after"><![CDATA[
            <td class="text-right">{% if product.quantity <= 0 %} <span class="label label-warning">{{ product.quantity }}</span> {% elseif product.quantity <= 5 %} <span class="label label-danger">{{ product.quantity }}</span> {% else %} <span class="label label-success">{{ product.quantity }}</span> {% endif %}</td>
			]]></search>
			<add><![CDATA[
            {% if not vendor_user %} 
                {% for vendor in vendors %}
                    {% if vendor.vendor_id == product.vendor_id %}
                        <td class="text-left">{{ vendor.name }}</td>
                    {% endif %}
                {% endfor %}
            {% endif %} 
	        ]]></add>
		</operation>

        <operation>
			<search position="replace"><![CDATA[
            <td class="text-center" colspan="8">{{ text_no_results }}</td>
			]]></search>
			<add><![CDATA[
            <td class="text-center" colspan="9">{{ text_no_results }}</td>
	        ]]></add>
		</operation>

        <operation>
			<search position="before"><![CDATA[
            var filter_status = $('select[name=\'filter_status\']').val();
			]]></search>
			<add><![CDATA[
            var filter_vendor_id = $('select[name=\'filter_vendor_id\']').val();
            if (filter_vendor_id) {
                url += '&filter_vendor_id=' + encodeURIComponent(filter_vendor_id);
            }
	        ]]></add>
		</operation>

    </file>

    <file name="admin\view\template\catalog\product_form.twig">
		<operation>
			<search position="after" offset="2"><![CDATA[
            <input type="hidden" name="manufacturer_id" value="{{ manufacturer_id }}" />
			]]></search>
			<add><![CDATA[
            <div class="form-group" {% if user_group_id == 10 %} style="display:none" {% endif %}>
                <label class="col-sm-2 control-label" for="input-vendor"><span data-toggle="tooltip" title="{{ help_vendor}}">{{ entry_vendor }}</span></label>
                <div class="col-sm-10">
                  <select name="vendor_id" id="input-vendor" class="form-control">
                    <option value=""></option>
                    {% for vendor_user in vendor_users %}   
                    {% if vendor_user.vendor_user_id == vendor_id %}
                      <option value="{{ vendor_user.vendor_user_id }}" selected="selected">{{ vendor_user.name }}</option>
                    {% else %}                  
                      <option value="{{ vendor_user.vendor_user_id }}">{{ vendor_user.name }}</option>
                    {% endif %}
                    {% endfor %}
                  </select>
                </div>
            </div>
	        ]]></add>
		</operation>
    </file>

</modification>